---
title: "An Analysis of the Effects of COVID-19 on the NYC Area and General Populus"
author: "Jana Alghamdi, Sharazad Ali, Yurie Han, Trey McCray, Andres Villada"
output: pdf_document
fontsize: 10pt
geometry: margin = 1in
---

# Introduction:
As of 2023, we live in a relatively post-pandemic era. COVID-19 affected us all
in some way or another so we were intrigued to see what data trends reveal, on
both a national and highly populated area, as the pandemic went on and what 
lessons we could learn from these trends to better prepare ourselves for future
national health crises. In addition we also wanted to look at the COVID-19
history in particular in the NYC area as a small part because of how densely
populated the area is. Which would allow us to add much more data in an easier
way to make a comparison to the general population. We also wanted to see within
the data trends, segment groupings based on age groups and/or racial
demographics. We believed that certain marginalized demographics would be more
negatviely effected by the pandemic due to lacking more financial resources on
average to afford treatment. Additionally, we anticipated that more densely
populated areas would exhibit more severe and common cases of COVID-19. Overall,
the purpose of our overall study was to make an larger analysis of a known topic
in COVID-19. To educate ourselves personally on its effects in the general
population using many different forms of statistical analysis and modelling in
general. Through the techniques we learned in class from sql databsing to making
conditional plots we were able to come to our own conclusions as a group on
COVID-19. 


# Primary Data Set:
  Our primary data set is the "COVID-19 Case Surveillance Public Use Data"
published by the U.S. Department of Health & Human Services. Featuring 95M+
rows, this case surveillance public use data set has 12 elements for all
COVID-19 cases shared with CDC and includes demographics, any exposure history,
disease severity indicators and outcomes, presence of any underlying medical
conditions and risk behaviors, and no geographic data. 
  The COVID-19 case surveillance database includes individual-level data
reported to U.S. states and autonomous reporting entities, including New York
City and the District of Columbia (D.C.), as well as U.S. territories and
affiliates.

source: 
https://catalog.data.gov/dataset/covid-19-case-surveillance-public-use-data

# Secondary Data Set:
1) Our first secondary data set is the "Hospital Inpatient Discharges (SPARCS
De-Identified): 2019" published by the New York State Department of Health.
This 2M+ row data set contains patient information for the 2019 year including
discharge level detail on patient characteristics, diagnoses, treatments,
services, and charges. This data file contains basic record level detail for
the discharge. Although this 2019 year data set does not contain any mention
of COVID-19 due to being before the pandemic, we wanted to use it to analyze
just how a normal year of inpatients would look like prior to the pandemic for
our future observations.

source: 
https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Identified/4ny4-j5zv

2) Our second secondary data set is the "Hospital Inpatient Discharges (SPARCS
De-Identified): 2020" published by the New York State Department of Health.
This 2M+ row data set contains patient information for the 2020 year including
discharge level detail on patient characteristics, diagnoses, treatments,
services, and charges. This data file contains basic record level detail for
the discharge. It is also worth noting that this is the first year of the
pandemic so we wanted to use this year's inpatient data to observer any strain
on the hospitals in New York state.

source:
https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Identified/nxi5-zj9x

3) Our third secondary data set is the "Hospital Inpatient Discharges (SPARCS
De-Identified): 2021" published by the New York State Department of Health.
This 2M+ row data set contains patient information for the 2021 year including
discharge level detail on patient characteristics, diagnoses, treatments,
services, and charges. This data file contains basic record level detail for
the discharge. This year's inpatient data has the context of imposed lockdowns
and the beginning of vaccinations to account for in observations.

source:
https://health.data.ny.gov/Health/Hospital-Inpatient-Discharges-SPARCS-De-Iden
tified/tg3i-cinn

```{r setup, include=FALSE, echo = FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE, echo = FALSE) 
```

```{r load-data}
library(ggplot2)
library(ggpmisc)
library(readr)
library(waffle)
library(ggcorrplot)
library(ggridges)
library(viridis)
library(hrbrthemes)
library(tibble)
library(dplyr)
library(knitr) 
library(RSQLite)
library(grid)
library(gridExtra)
library(xtable)
library(kableExtra)
dcon <- dbConnect(SQLite(), dbname = "data/covid_info_db.db")
```

# Nationwide related COVID-19 Data and Observations
- COVID-19 Patient Visits to the ICU Over Time:

```{r trey}
res <- dbSendQuery(conn = dcon, 
                   "SELECT cdc_case_earliest_dt
                    FROM 'COVID Cases'
                    WHERE icu_yn == 'Yes'
                   ")
yes_icu <- dbFetch(res, -1)
dbClearResult(res)

icu_yes_table <- na.omit(table(yes_icu$cdc_case_earliest_dt))
plot(icu_yes_table, 
     main="Covid Patient Visits to the ICU Over Time", 
     xlab="Time", 
     ylab = "Frequency", 
     col="skyblue"
)
```

*Question of Interest*:

What can we infer and notice about the change in COVID-19 patient visits in the
ICU over time? 

*Introduction*:

The plot is a running Time vs Frequency chart of COVID-19 Patients in the ICU over
time. The x-axis is the timing of ICU occurrences from Jaunary of 2020 to
December of 2021. The y-axis is the daily number of ICU patients who have
COVID-19 over time.  The chart shows the increases and decreases of the ICU
frequency filled into the chart of the given time-span. 

*Interpretation*:

Based off of the plot of “Covid Patients Visits to the ICU overtime,” the appearance of COVID-19 first began with the initial spike between
January of 2020 and June of 2020 with the frequency of patient reaching a
consistent peak of roughly 550 patients entering the ICU every day. With the
decrease of the ICU patients after the initial peak, one can assume the timeline coincides with the enforcement of lockdowns, which kept people inside and prevented a significant number of ICU visits from June 2020 to November 2020. It is also important to note that during this time period is when booster vaccinations were rolling out as well, likely driving the decline of COVID-19 inpatients. Another spike occurred in early 2021 with a relaxation of lockdown procedures, leading to an increase in COVID-19 cases. When this plot is combined with the overall daily number of COVID-19 cases, a similar alignment in plotting exists. It is inferred that this is in regards to the changes between enforced lockdowns and relaxed lockdowns. 

- Mortality Distribution over Age Groups:

```{r plot 2}
#yeses <- subset(CDC_data, CDC_data$death_yn == "Yes") Computed yeses
#nos <- subset(CDC_data, CDC_data$death_yn == "No") Computed nos

## YES DEATH
#CDC_datale(yeses$age_group)
par(mfrow = c(1, 2))
age_yes_ct <- c(rep (0, 853), rep(10, 1354), rep(20, 5019), rep(30, 13175), 
                rep (40, 34629), rep (50, 79633), rep(60, 171153), 
                rep(70, 70902), rep(80, 197764))
boxplot(age_yes_ct, xlab = "Died", ylab = "Age", col = "skyblue")

## NO DEATH
#CDC_datale(nos$age_group)
age_no_ct <- c(rep (0, 2080041), rep(10, 3378611), rep(20, 3594496), 
               rep(30, 4373689), rep (40, 4063857), rep (50, 3831111), 
               rep(60, 2981022), rep(70, 479060), rep(80, 495815))
boxplot(age_no_ct, xlab = "Did Not Die", ylab = "Age", col = "skyblue")
```
*Question of Interest*:

Is there a difference in mortality risk for COVID-19 between the age groups?

*Introduction*:

A box and whisker plot that represents the age group distribution of those
diagnosed with COVID-19 from 2020 to 2021 and died is compared to another box
and whisper plot representing the age distribution of those diagnosed with
COVID-19 from 2020 to 2021 but did not die. The age distributions are separated
by decades in age (10-19 years, 20-29 years, …, and 80+ years). The box plot
for those who died from COVID-19 has higher values in terms of its 1st
quartile, median, and 3rd quartile values when compared to the box plot for
those who did not die. 

*Interpretation*:

The data for those who died is mainly concentrated towards the older ages (50%
of the data lies from 60-80 years old). Those who did not die were younger
compared to those who did die. Additionally, the data for those who did not die
is more spread out. However, because the dataset does not specify the specific
age of each person diagnosed with COVID-19 and separates them by age
distribution, the exact age for each quartile can not be determined. 

- Proportions of Length of Stay Averages by Race by Year: 

```{r Andres}
# TODO: If other race, substitue with Latino if available
# TODO: Include insurance information
res <- dbSendQuery(conn = dcon,
                   "SELECT Race, AVG(LengthofStay) AS 'Average_Length_of_Stay' 
                    FROM 
                    (SELECT Race, LengthofStay
                    FROM 'Inpatient Data 2020'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)' 
                    UNION ALL 
                    SELECT Race, LengthofStay
                    FROM 'Inpatient Data 2021'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)')
                    GROUP BY Race
                   ")
dplyrQ <- dbFetch(res, -1)
dbClearResult(res)
df<- as.data.frame(dplyrQ)

# Compute percentages
df$fraction = 
  df$Average_Length_of_Stay / sum(df$Average_Length_of_Stay)

# Compute the cumulative percentages (top of each rectangle)
df$ymax = cumsum(df$fraction)

# Compute the bottom of each rectangle
df$ymin = c(0, head(df$ymax, n=-1))
 
# Make the plot
ggplot(df, aes(ymax=ymax, ymin=ymin, xmax=4, xmin=3, 
                 fill=Race)) +
     scale_fill_brewer(palette="Blues") +
     geom_rect() +
     coord_polar(theta="y") + 
     xlim(c(2, 4)) + 
     labs(title = 
            "Proportions of Length of Stay Averages by Race for 2020-2021")
```

*Question of Interest*:

Is there a difference in length of stay for COVID-19 illness across races?

*Introduction*: 

The donut plot above consists of the proportions of length of stay averages by 
race by year for 2020 and 2021. A legend for each race is placed on the right
side and the donut chart and legend is color coded for readability. 
Additionally there are labels around the donut for reading and estimating the
amount of proportion each race category takes up for each section of the donut.

*Interpretation*:

Given the plot that produced and the averages by race generated
by the dplyr library, it can be concluded that there is not a significant 
difference in length of stay for COVID-19 illness across races. Visually 
speaking, the plot has an even distribution of proportions between the races:
Black/African American, Multi-racial, Other Race, and White (the fact that
the Other Race category is about the same proportion as the other races is
reasonable evidence to conclude that other races have approximately the same
length of stays on average as well). By investigating the data, it is shown
that the maximum average length of stay by race was the Other Race category 
with 8.893880 days. The minimum average length of stay was Black/African
American with 8.577218. Therefore, given the very small difference between the
maximum and minimum average days of length of stay, it is determined that there was
no significant difference of Length of Stay by race for COVID-19 patients.

- Frequency of COVID-19 Patients Over Races:

```{r jana}
# Edited plot code:
res <- dbSendQuery(conn = dcon, 
                   "SELECT race_ethnicity_combined, 
                    COUNT(race_ethnicity_combined) AS freq
                    FROM 'COVID Cases'
                    GROUP BY race_ethnicity_combined
                   ")
race <- dbFetch(res, -1)
dbClearResult(res)

ggplot(race, aes(x=race_ethnicity_combined, y=freq))+
  geom_segment( aes(x=race_ethnicity_combined, 
                    xend=race_ethnicity_combined, y=0, yend=freq), 
                color="grey") +
                geom_point( color="darkblue", size=4) +
  theme_light() +
  theme(
    panel.grid.major.x = element_blank(),
    panel.border = element_blank(),
    axis.ticks.x = element_blank()
  ) +  theme(axis.text.x = element_text(angle = 45,hjust = 1, size =8)) +
  xlab("Races") +
  ylab("Frequency of COVID-19 cases") + 
labs(title = "The Frequency of COVID-19 Cases by Race")

# dplyr
res <- dbSendQuery(conn = dcon, 
                   "SELECT race_ethnicity_combined, 
                   COUNT(race_ethnicity_combined) AS freq
                    FROM 'COVID Cases'
                    WHERE race_ethnicity_combined IS NOT NULL
                    GROUP BY race_ethnicity_combined
                    ORDER BY freq DESC
                   ")
dplyrQ <- dbFetch(res, -1)
dbClearResult(res)
df <- as.data.frame(dplyrQ) 
kable(df)

```

*Question of Interest*:

How accurate is our plot of the frequency of COVID-19 cases by race compared to
the overall population in the US?

*Introduction*: 

The lollipop chart represents the number of COVID-19 cases (y axis) that
occurred in each racial group. In total, there are nine distinct racial groups
(the x axis) reflected in the graph, each lollipop segment representing a
different race. Three of the segments exhibit individuals that are not of one
distinct racial group, these groups are: missing, unknown, and other. The
‘missing’ category reflects individuals who left out their race from the data,
the ‘unknown’ category is participants who do not know their racial group,
while the ‘other’ category belongs to individuals who could be mixed, or do not
conform to any of the distinct racial groups. The overall purpose of this graph
is to showcase the relationship between race and COVID-19 cases.

*Interpretation*:

As shown in the chart, the maximum number of COVID-19 cases occurred among the
White racial group, while Hispanic people had the second highest number of
cases. Individuals of Native Hawaiian/Other Pacific Islander descent exhibited
the lowest number of COVID-19 cases (excluding ‘missing’, ‘other’, and
‘unknown’). From these statistics, one can conclude that white people in
America overall had higher rates of COVID-19. This data makes sense because the
percentage of white people, which is around 60.1%, makes up most of the US. We
have that 16,248,211 of white people got COVID-19 out of the 231.9 million. Thus,
the weight that the percentage holds corresponds to why we see in the data
above they have the highest cases of COVID-19. Similarly with Hispanic people in
which they make up almost 18.5% of the US. Out of the 62.57 million Hispanic
people in the US,6,715,048 of them got COVID-19. Lastly, Native Hawaiian/Other 
Pacific Islander make up 0.2%, meaning that out of the 1.4
million, 78,123 of them got COVID-19. Thus, it is very important when looking at
the frequency of COVID-19 cases of the ethnicity/race of a certain population to 
consider what percentage each ethnicity/race makes up of the
whole population at hand.

- Frequency of COVID-19 Deaths by Sex:

```{r yurie} 
res <- dbSendQuery(conn = dcon, 
       "SELECT c.sex, COUNT(*) as frequency 
        FROM `COVID Cases` c 
        WHERE c.death_yn = 'Yes' 
        GROUP BY c.sex")

count_by_sex <- dbFetch(res, -1)
dbClearResult(res)

ggplot(data = count_by_sex, aes(x=sex, y=frequency)) +
  geom_bar(stat="identity", fill = "#0073C2FF") +
  xlab("Sex") +
  ylab("Frequency of COVID-19 Deaths") + 
  labs(title = "The Frequency of COVID-19 Deaths by Sex")

###### table
res <- dbSendQuery(conn = dcon,
                   "SELECT sex AS 'Sex', COUNT(sex) AS 'Count'
                    FROM 'COVID Cases'
                    WHERE death_yn = 'Yes' AND sex IS NOT NULL
                    GROUP BY sex")
dplyrQ <- dbFetch(res, -1)
dbClearResult(res)
kable(dplyrQ)
```

*Question of Interest*:

Is there statistical evidence for sex differences in death caused by COVID-19?

*Introduction*:


The graph above plots the frequency of COVID-19 deaths by sex from 2020 -
2023. The x-axis represents each patient’s sex, which was identified as being
either “Female,” “Male,” “Missing”, “Other”, or “Unkown.” The y-axis 
represents the amount that each of the labels on the x-axis died having 
COVID-19.

*Interpretation*:

  According to the graph, males ranked the highest when it came to the
reported COVID-19 deaths, followed by females. The other groups of ‘Missing,’
‘Other,’ and ‘Unknown’ had a very minimal frequency when compared to the
females’ and males’ frequency. However, the difference between females and
males is minimal, meaning that is barely a difference between the sexes and
the COVID-19 deaths throughout the years of 2020 to 2023. The
slight difference between them might be due to the fact that more males 
reported COVID-19 deaths than females. Additionally, males having a higher frequency of 
COVID-19 may reflect the fact that men tend to work outside of the house at a 
higher rate than women, thus exposing them to the disease more. Another factor
is the fact that men tend to have a weaker immune system than women.

# New York State wide COVID-19 Data and Observations
- Length of Stay over Total Charges for COVID-19 Patients for 2020-2021:

```{r shary, results="asis"}
#—------------- 2020 Data —---------------
res <- dbSendQuery(conn = dcon, 
                   "SELECT LengthofStay AS 'Length.of.Stay', 
                           'ZipCode-3digits' AS 'ZipCode-3digits', 
                            AgeGroup AS 'Age.Group', 
                            TotalCharges AS 'Total.Charges'
                    FROM 'Inpatient Data 2020'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)'
                   ")
covid2020 <- dbFetch(res, -1)
dbClearResult(res)

covid2020$Length.of.Stay = as.numeric(as.character(covid2020$Length.of.Stay))
p1 <-
  ggplot(covid2020, aes(fill=covid2020$Age.Group, y=covid2020$Total.Charges, 
                      x= covid2020$Length.of.Stay)) + 
  geom_area(colour="dark blue", size = .1) + 
  labs(title=
    "Length of Stay vs Total Charges for COVID-19 Inpatient Care in NYC 2020",
      x = "Length of Stay in Hospital", y = "Total Hospital Charges") + 
  guides(fill=guide_legend(title="Age Groups")) + 
  scale_fill_brewer(palette = "PuBu")
#—------------- 2021 Data —---------------
res <- dbSendQuery(conn = dcon, 
                   "SELECT LengthofStay AS 'Length.of.Stay', 
                           'ZipCode-3digits' AS 'ZipCode-3digits', 
                            AgeGroup AS 'Age.Group', 
                            TotalCharges AS 'Total.Charges'
                    FROM 'Inpatient Data 2021'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)'
                   ")
covid2021 <- dbFetch(res, -1)
dbClearResult(res)

covid2021$Length.of.Stay = as.numeric(as.character(covid2021$Length.of.Stay))

p2 <- 
  ggplot(covid2021, aes(fill=covid2021$Age.Group, y=covid2021$Total.Charges, 
                      x= covid2021$Length.of.Stay)) + 
    geom_area(colour="dark blue", size = .1) + 
  labs(title=
        "Length of Stay vs Total Charges for COVID-19 Inpatients in NYC 2021",
       x = "Length of Stay in Hospital", y = "Total Hospital Charges") + 
  guides(fill=guide_legend(title="Age Groups")) + 
  scale_fill_brewer(palette = "PuBu")

# ------ plotting ------
grid.arrange(p1, p2, nrow = 2)

# ---- sql ----
res <- dbSendQuery(conn = dcon, 
                   "SELECT LengthofStay AS 'Length.of.Stay', 
                            AgeGroup AS 'Age.Group',
                            TotalCharges AS 'Total.Charges'
                    FROM 'Inpatient Data 2020'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)' AND 
                            LengthOfStay IS NOT NULL AND
                            TotalCharges IS NOT NULL
                   ")
covid2020 <- dbFetch(res, -1)
dbClearResult(res)

covid2020$Length.of.Stay = as.numeric(as.character(covid2020$Length.of.Stay))
data <- as_tibble(covid2020)
data$Length.of.Stay = as.numeric(as.character(data$Length.of.Stay))
df <- na.omit(data) %>% 
  group_by(Age.Group) %>%
  summarize(correlation = cor(Length.of.Stay, Total.Charges))
kable(df)
```



*Question of Interest*:

What is the correlation between length of stay in the hospital and total
hospital charges within each age group?

*Introduction*:


The plots above graph the relationship between total hospital charges for
COVID-19 inpatient care in a NYC hospital and the number of days the patient
stayed in the hospital. Data was collected and graphed in the plots from 2020
and 2021, respectively. The x-axis represents the length of stay each patient
stayed in the hospital for, and the y-axis represents the total hospital
charges for that patient. Through a stacked area chart, each age group
(separated by 0-17 years old, 18-29, 30-49, 50-69, and 70 or older), is
categorized and stacked on top of each other to analyze how the age group’s
length of stay changes over the progression of total hospital charges.

*Interpretation*:


The 2020 plot is fairly similar to the 2021 plot, which shows a somewhat
positive correlation between the length of stay in the hospital and the total
hospital charges, with a longer length of stay correlating to higher hospital
charges. Additionally, the plots both show that the younger the age group, the
higher the charges are for the same length of stay when compared to the older
age groups. However, the highest charges occur for 18 to 29 year olds at an
extended length of stay. For 2020, the highest charge was for 18 to 29 year
olds at the hospital for approximately 105 days. For 2021, the highest charge
was for 18 to 29 year olds at the hospital for approximately 80 days. As each
age group gets older, each group reaches their highest charge at a higher
length of stay. This is likely due to younger people having less access to
health insurance, from either being unemployed or having less life savings.
Additionally, it is less likely for younger people to be staying in the
hospital for an extended period of time due to less severity in their illness
when compared to the older age groups.
	In order to further analyze the plot, the correlation between the length of
stay and total charges was analyzed for each age group. Across all age groups,
the correlation proved to be very strong, as all of the age groups had a
correlation in the ~.80 range, while the 70 or older age group had a
correlation of .75. This exhibits strong evidence that there is a direct
relationship between length of stay and total charges: as the length of stay
increases, the total charge for each patient also increases across all age
groups.

- Inpatients Based on NY State Areas (2019-2021)

```{r waffle plot}
res <- dbSendQuery(conn = dcon,
                   "SELECT HospitalServiceArea
                    FROM 
                    (SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2019'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)' 
                    UNION ALL 
                    SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2020'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)'
                    UNION ALL 
                    SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2021'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)')
                    
                   ")
dplyrQ <- dbFetch(res, -1)
dbClearResult(res)
df <- data.frame(name = names(table(as.data.frame(dplyrQ))),
                 value = as.numeric(table(as.data.frame(dplyrQ))))
# Waffle plot
## Plot
waffle(table(as.data.frame(dplyrQ))/1000, rows=10, size=1, 
       colors=c("#44D2AC", "navy", "blue1", 
                "#3A9ABD", "dodgerblue", "deepskyblue", "skyblue", 
                "royalblue"), 
       title="Inpatients Based on NY State Areas 2019-21", 
       xlab="1 square = 1000 people")
# table
#res <- dbSendQuery(conn = dcon,
#                   "SELECT HospitalServiceArea AS 'Hospital Service Area' 
#                      COUNT(HospitalServiceArea) AS '2019'
#                    FROM 'Inpatient Data 2019'
#                    WHERE HospitalServiceArea IS NOT NULL
#                    GROUP BY HospitalServiceArea
#                  ")
res <- dbSendQuery(conn = dcon,
                   "SELECT HospitalServiceArea AS 'Hospital Service Area',
                      COUNT(HospitalServiceArea) AS 'Count'
                    FROM 
                    (SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2019'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)' 
                    UNION ALL 
                    SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2020'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)'
                    UNION ALL 
                    SELECT HospitalServiceArea
                    FROM 'Inpatient Data 2021'
                    WHERE CCSRDiagnosisDescription ==
                            'CORONAVIRUS DISEASE 2019 (COVID-19)')
                    WHERE HospitalServiceArea IS NOT NULL
                    GROUP BY HospitalServiceArea
                   ")
dplyrQ <- dbFetch(res, -1)
dbClearResult(res)
kable(dplyrQ)

```
*Question of Interest*:

Is COVID-19 more likely to transmit in some areas than others?

*Introduction*: 

The plots above is a waffle plot detailing the number of inpatients and what
NY state area they belonged to for the years 2019, 2020, and 2021. Thus this
waffle plot is a combination of the waffle plots for 2019, 2020, and 2021.
The waffle plot is color-coded for convenience and each square represents 1000
people. The square without a title in the legend is for inpatients who did not 
identify with an area and did not self-report. 

*Interpretation*:

In the plot above it's evident that the New York City area had the highest
number of inpatients. This is in constrast to less populated areas which
demonstrated less inpatient admissions. This demonstrates that there is a 
positive correlation between densely populated areas with the number of 
inpatients admitted. In addition when all waffle plots of each year are
plotted individually, it can be seen that the proportions of each New York
area and their number of inpatients do not change, demonstrating a lack of
outward or inward migration likely due to the pandemic and lockdowns.

# General COVID-19 Observations
- Killer Plot

```{r}
######################## HELPER FUNCTIONS ########################

# Adds a clue into the clue section
#
# Parameters:
# clue: clue entry as a string
# r_start: start row cell pos
# c_start: start col cell pos
# c_end: ending col cell pos
# size: font size
add_clue <- function(clue, r_start, c_start, c_end, size = 1.0) {
  pushViewport(viewport(layout.pos.row = r_start, 
                        layout.pos.col = c_start:c_end))
  grid.text(clue, gp = gpar(cex = size))
  popViewport()
}

# Adds a row into the cross word space
#
# Parameters:
# word: crossword entry as a string
# r_start: starting row cell position
# c_start: starting column cell position
# has_perc: boolean for whether or not the entry has a percentage
# perc: percentage represented as a string (must be of format XX%)
add_col <- function(word, r_start, c_start, has_perc = FALSE, perc = "00%") {
  for (i in r_start:(r_start + nchar(word) - 1)) {
    pushViewport(viewport(layout.pos.row = i, layout.pos.col = c_start))
    grid.rect(gp = gpar(lwd = 3, col = "navyblue"))
    letter_at <- i - r_start + 1
    grid.text(substr(word, letter_at, letter_at))
    popViewport()
  }
  if (has_perc) {
    pushViewport(viewport(layout.pos.row = (r_start + nchar(word)), 
                          layout.pos.col = c_start))
    grid.rect(gp = gpar(lwd = 3, col = "navyblue"))
    grid.text(perc, gp = gpar(cex = 0.75))
    popViewport()
  }
}

# Adds a column into the cross word space
#
# Parameters:
# word: crossword entry as a string
# r_start: starting row cell position
# c_start: starting column cell position
# has_perc: boolean for whether or not the entry has a percentage
# perc: percentage represented as a string (must be of format XX%)
add_row <- function(word, r_start, col_start, has_perc = FALSE, perc = "00%") {
  for (i in col_start:(col_start + nchar(word) - 1)) {
    pushViewport(viewport(layout.pos.row = r_start, layout.pos.col = i))
    grid.rect(gp = gpar(lwd = 3, col = "navyblue"))
    letter_at <- i - col_start + 1
    grid.text(substr(word, letter_at, letter_at))
    popViewport()
  }
  if (has_perc) {
    pushViewport(viewport(layout.pos.row = r_start, 
                          layout.pos.col = (col_start + nchar(word))))
    grid.rect(gp = gpar(lwd = 3, col = "navyblue"))
    grid.text(perc, gp = gpar(cex = 0.75))
    popViewport()
  }
}

add_num <- function(num, r, c) {
  pushViewport(viewport(layout.pos.row = r, layout.pos.col = c))
  grid.rect(gp = gpar(lwd = 0))
  grid.text(num)
  popViewport()
}

######################## SETUP GRID ########################

# Set new page and new layout
grid.newpage()
ly = grid.layout(20, 22)

# For testing layout:
#grid.show.layout(ly)

# Create the grid
pushViewport(viewport(layout = ly))

######################## ACROSS ########################
# Across Title
pushViewport(viewport(layout.pos.row = 14, layout.pos.col = 1:6))
grid.text("Across", gp = gpar(fontface = "bold", cex = 1.2))
popViewport()

# 3.
# Clue Num
add_num("3", 4, 10)
# Clue
add_clue("3. Age Group with Highest Hospital Charges.", 15, 1, 11, 0.78)
# Space
add_row("YOUNGER", 5, 10, TRUE, "13%")

# 5.
# Clue Num
add_num("5", 8, 5)
# Clue
add_clue("5. What holiday did patients visit the ICU the most?", 16, 1, 12, 0.78)
# Space
add_row("CHRISTMAS", 8, 6, FALSE)

# 6.
# Clue Num
add_num("6", 10, 5)
# Clue
add_clue("6. Which Sex had the highest frequency of covid?", 17, 1, 12, 0.78)
# Space
add_row("WOMEN", 10 , 6,TRUE, "41%")

######################## DOWN ########################
# Down Title
pushViewport(viewport(layout.pos.row = 14, layout.pos.col = 11:17))
grid.text("Down", gp = gpar(fontface = "bold", cex = 1.2))
popViewport()

# 1.
# Clue Num
add_num("1", 3, 17)
# Clue
add_clue("1. Relationship between length of stay and charges incurred.", 
         15, 12, 22, 0.78)
# Space
add_col("DIRECT", 3, 16)


# 2.
# Clue Num
add_num("2", 3, 13)
# Clue
add_clue("2. The trend in migration in NY remained --------?", 
         16, 12, 20, 0.78)
# Space
add_col("UNCHANGED", 4, 13)

# 4.
# Clue Num
add_num("4", 6, 8)
# Clue
add_clue("4. Which race had the highest number of covid cases?", 
         17, 11, 22, 0.78)
# Space
add_col("WHITE", 6, 9, TRUE, "39%")

######################## TITLE ########################
# Activate cells for title
pushViewport(viewport(layout.pos.row = 2, layout.pos.col = 1:22))
grid.rect(gp = gpar(lwd = 3, col = "navyblue"))
grid.text("Killer Crossword Plot", gp = gpar(fontface = "bold", cex = 1.2))
popViewport()
```

*Question of Interest*:

What are the key data trends from our previous plots?

*Introduction and Interpretation*:

The killer plot we decided to make was a crossword puzzle representing the 
outcomes we found from the overall data visualizations. As you can see, at the 
bottom puzzle are the hints of the crossword indicating the questions for each 
of the outcomes. For example, in the ‘across’ section of the killer plot, the 
third statement is “Age Group with Highest Hospital Charges” which matches to 
number three on the plot with the answer being, “Younger Age group at 13%”


# Conclusion
After analyzing the data, there are various findings that we arrived at. The 
general demographic breakdown of our results revealed that White individuals 
had the highest frequency of cases but a lower rate than some of the other 
racial groups, and men exhibited the highest rate of cases compared to other 
sexes. Additionally, after looking at the hospital trends overall, we noticed 
that the trends in ICU patients over time are indicative of the chronological 
order of the pandemic; for example, during lockdown rulings there seemed to be 
fewer cases, while during peaks of the pandemic, ICU patient numbers rose 
(especially in more populated areas). An interesting finding to note is that 
younger age groups incurred higher charges for the same length of hospital 
stay, which we attributed to their lack of health insurance. Across all races, 
there seemed to be an even length of hospital stay, which substantiates proof 
that race does not necessarily impact the severity of COVID-19 symptoms. 

# Future Works
After analyzing the data, there are various findings that we arrived at. The
general demographic breakdown of our results revealed that White individuals had
the highest frequency of cases but a lower rate than some of the other racial
groups, and men exhibited the highest rate of cases compared to other sexes.
Additionally, after looking at the hospital trends overall, we noticed that the
trends in ICU patients over time are indicative of the chronological order of
the pandemic; for example, during lockdown rulings there seemed to be fewer
cases, while during peaks of the pandemic, ICU patient numbers rose (especially
in more populated areas). An interesting finding to note is that younger age
groups incurred higher charges for the same length of hospital stay, which we
attributed to their lack of health insurance. Across all races, there seemed to
be an even length of hospital stay, which substantiates proof that race does not
necessarily impact the severity of COVID-19 symptoms. 

